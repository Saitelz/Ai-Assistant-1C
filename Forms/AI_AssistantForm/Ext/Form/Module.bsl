#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    
    // Инициализация формы
    ИнициализироватьФорму();
    
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовФормы

&НаКлиенте
Процедура ТекстЗапросаПриИзменении(Элемент)
    // Нет обработки
КонецПроцедуры

&НаКлиенте
Процедура КлючAPIПриИзменении(Элемент)
    // Нет обработки
КонецПроцедуры

&НаКлиенте
Процедура МодельИИПриИзменении(Элемент)
    // Нет обработки
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКоманд

&НаКлиенте
Процедура ОтправитьЗапрос(Команда)
    
    Если ПустаяСтрока(ТекстЗапроса) Тогда
        ПоказатьПредупреждение(, "Введите ваш вопрос перед отправкой!");
        Возврат;
    КонецЕсли;
    
    // Показываем индикатор загрузки
    ПоказатьОжидание(НСтр("ru = 'Отправка запроса к ИИ...'"));
    
    // Вызываем асинхронно серверную процедуру
    ВыполнитьОбработкуОповещения(Новый ОписаниеОповещения("ПослеОтправкиЗапроса", ЭтотОбъект), "ОтправитьЗапросКИИ_Сервер");
    
КонецПроцедуры

&НаКлиенте
Процедура ПослеОтправкиЗапроса(Результат, ДополнительныеПараметры) Экспорт
    
    // Скрываем индикатор загрузки
    СкрытьОжидание();
    
    // Обновляем ответ на форме
    ОбновитьОтветАссистента(Результат);
    
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьНастройки(Команда)
    
    Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.СтраницаНастройки;
    
КонецПроцедуры

&НаКлиенте
Процедура СохранитьНастройки(Команда)
    
    СохранитьНастройкиНаСервере();
    ПоказатьПредупреждение(, "Настройки сохранены!");
    
КонецПроцедуры

&НаКлиенте
Процедура ВернутьсяКАссистенту(Команда)
    
    Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.СтраницаОсновная;
    
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ИнициализироватьФорму()
    
    // Инициализация форматированного документа
    ОтветАссистента = Новый ФорматированныйДокумент;
    ОтветАссистента.УстановитьТекст(
        "Здравствуйте! Я - ИИ-ассистент для 1С:ERP. Напишите ваш вопрос в поле выше и нажмите кнопку 'Отправить запрос'."
    );
    
    // Загружаем настройки API
    НастройкиAPI = AI_AssistantModule.ПолучитьНастройкиAPI();
    КлючAPI = НастройкиAPI.Ключ;
    МодельИИ = НастройкиAPI.Модель;
    
КонецПроцедуры

&НаСервере
Функция ОтправитьЗапросКИИ_Сервер()
    
    // Формируем контекст запроса
    КонтекстЗапроса = Новый Структура;
    КонтекстЗапроса.Вставить("ТекущаяФорма", ПолучитьИмяТекущейФормы());
    КонтекстЗапроса.Вставить("ТекущийРаздел", ПолучитьИмяТекущегоРаздела());
    
    // Отправляем запрос через общий модуль
    Результат = AI_AssistantModule.ОтправитьЗапросКИИ(ТекстЗапроса, КонтекстЗапроса);
    
    Возврат Результат;
    
КонецФункции

&НаКлиенте
Процедура ОбновитьОтветАссистента(Ответ)
    
    // Создаем форматированный документ
    ФорматированныйОтвет = Новый ФорматированныйДокумент;
    ФорматированныйОтвет.УстановитьТекст(Ответ);
    
    // Устанавливаем его на форму
    ОтветАссистента = ФорматированныйОтвет;
    
КонецПроцедуры

&НаСервере
Процедура СохранитьНастройкиНаСервере()
    
    // Сохраняем настройки через общий модуль
    AI_AssistantModule.СохранитьНастройкиAPI(КлючAPI, МодельИИ);
    
КонецПроцедуры

&НаСервере
Функция ПолучитьИмяТекущейФормы()
    
    Попытка
        Возврат ЭтаФорма.ИмяФормы;
    Исключение
        Возврат "Неизвестно";
    КонецПопытки;
    
КонецФункции

&НаСервере
Функция ПолучитьИмяТекущегоРаздела()
    
    Попытка
        Возврат РабочийСтол.ПолучитьТекущийРаздел();
    Исключение
        Возврат "Неизвестно";
    КонецПопытки;
    
КонецФункции

#КонецОбласти 